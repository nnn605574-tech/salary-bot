import os
import logging
import sqlite3
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import Application, CommandHandler, ContextTypes, MessageHandler, filters

BOT_TOKEN = "8505806491:AAFoYNuE05wsuCeNw8-Lnw9FbGyNJ74kLsU"

logging.basicConfig(level=logging.INFO)

class SalaryBot:
    def __init__(self):
        self.setup_database()
    
    def setup_database(self):
        self.conn = sqlite3.connect('salary_bot.db', check_same_thread=False)
        self.conn.execute('''
            CREATE TABLE IF NOT EXISTS employees (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                phone TEXT UNIQUE NOT NULL,
                wallet TEXT,
                salary_balance REAL DEFAULT 0,
                position TEXT DEFAULT 'Ù…ÙˆØ¸Ù'
            )
        ''')
        self.conn.commit()
        print("âœ… Database ready")
    
    def create_main_keyboard(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
        keyboard = [
            [KeyboardButton("ğŸ‘¥ View Employees"), KeyboardButton("â• Add Employee")],
            [KeyboardButton("ğŸ’° Update Salary"), KeyboardButton("ğŸ“Š Balance Report")],
            [KeyboardButton("â“ Help")]
        ]
        return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        user = update.effective_user
        keyboard = self.create_main_keyboard()
        
        await update.message.reply_text(
            f"ğŸ¯ Welcome {user.first_name}!\n\n"
            "ğŸ¤– Salary Management Bot\n\n"
            "ğŸ“ Use the buttons below:",
            reply_markup=keyboard
        )
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±"""
        text = update.message.text
        
        if text == "ğŸ‘¥ View Employees":
            await self.list_employees(update, context)
        elif text == "â• Add Employee":
            await update.message.reply_text(
                "ğŸ“ Send employee data in this format:\n"
                "Name, Phone, Wallet, Salary\n\n"
                "Example:\n"
                "Mohammed, 123456789, wallet123, 1000"
            )
        elif text == "ğŸ’° Update Salary":
            await update.message.reply_text(
                "ğŸ“ Send update data in this format:\n"
                "Phone, Amount\n\n"
                "Example:\n"
                "123456789, 500\n"
                "123456789, -200"
            )
        elif text == "ğŸ“Š Balance Report":
            await self.balance_report(update, context)
        elif text == "â“ Help":
            await self.help_command(update, context)
        else:
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
            await self.process_input(update, context, text)
    
    async def process_input(self, update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©"""
        try:
            if "," in text:
                parts = [part.strip() for part in text.split(",")]
                
                if len(parts) == 4:  # Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù
                    name, phone, wallet, salary = parts
                    await self.add_employee_manual(update, name, phone, wallet, float(salary))
                
                elif len(parts) == 2:  # ØªØ­Ø¯ÙŠØ« Ø±Ø§ØªØ¨
                    phone, amount = parts
                    await self.update_salary_manual(update, phone, float(amount))
                
                else:
                    await update.message.reply_text("âŒ Invalid format. Use commas to separate data.")
            
            else:
                await update.message.reply_text("âŒ Please use the buttons or send data in correct format.")
                
        except ValueError:
            await update.message.reply_text("âŒ Error: Salary/Amount must be numbers")
        except Exception as e:
            await update.message.reply_text("âŒ Error processing data")
    
    async def add_employee_manual(self, update: Update, name: str, phone: str, wallet: str, salary: float):
        """Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù ÙŠØ¯ÙˆÙŠØ§Ù‹"""
        try:
            self.conn.execute(
                "INSERT INTO employees (name, phone, wallet, salary_balance) VALUES (?, ?, ?, ?)",
                (name, phone, wallet, salary)
            )
            self.conn.commit()
            await update.message.reply_text(
                f"âœ… Employee Added!\n\n"
                f"ğŸ‘¤ Name: {name}\n"
                f"ğŸ“ Phone: {phone}\n"
                f"ğŸ’³ Wallet: {wallet}\n"
                f"ğŸ’° Salary: {salary}"
            )
        except sqlite3.IntegrityError:
            await update.message.reply_text("âŒ Phone number already exists!")
    
    async def update_salary_manual(self, update: Update, phone: str, amount: float):
        """ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø§ØªØ¨ ÙŠØ¯ÙˆÙŠØ§Ù‹"""
        self.conn.execute(
            "UPDATE employees SET salary_balance = salary_balance + ? WHERE phone = ?",
            (amount, phone)
        )
        self.conn.commit()
        
        employee = self.conn.execute(
            "SELECT name FROM employees WHERE phone = ?", (phone,)
        ).fetchone()
        
        if employee:
            await update.message.reply_text(
                f"âœ… Salary Updated!\n\n"
                f"ğŸ‘¤ Employee: {employee[0]}\n"
                f"ğŸ“ Phone: {phone}\n"
                f"ğŸ’µ Amount: {amount}"
            )
        else:
            await update.message.reply_text("âŒ Phone number not found")
    
    async def list_employees(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†"""
        employees = self.conn.execute(
            "SELECT name, phone, wallet, salary_balance, position FROM employees"
        ).fetchall()
        
        if not employees:
            await update.message.reply_text("ğŸ“­ No employees found")
            return
        
        text = "ğŸ“‹ Employees List:\n\n"
        for emp in employees:
            text += f"ğŸ‘¤ {emp[0]}\n"
            text += f"ğŸ“ {emp[1]} | ğŸ’° {emp[3]}\n"
            text += f"ğŸ’³ {emp[2]} | ğŸ¯ {emp[4]}\n"
            text += "â”€" * 20 + "\n"
        
        await update.message.reply_text(text)
    
    async def balance_report(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯"""
        employees = self.conn.execute(
            "SELECT name, salary_balance FROM employees"
        ).fetchall()
        
        if not employees:
            await update.message.reply_text("ğŸ“­ No employees found")
            return
        
        text = "ğŸ’° Salary Report:\n\n"
        total = 0
        for emp in employees:
            text += f"ğŸ‘¤ {emp[0]}\nğŸ’µ {emp[1]}\n\n"
            total += emp[1]
        
        text += f"ğŸ“Š Total: {total}"
        await update.message.reply_text(text)
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø³Ø§Ø¹Ø¯Ø©"""
        help_text = """
        ğŸ¤– **How to use:**

        **ğŸ“ Add Employee:**
        Click â• Add Employee
        Then send: Name, Phone, Wallet, Salary
        Example: Mohammed, 123456789, wallet123, 1000

        **ğŸ’° Update Salary:**
        Click ğŸ’° Update Salary  
        Then send: Phone, Amount
        Example: 123456789, 500

        **ğŸ‘¥ View Employees:**
        Click ğŸ‘¥ View Employees

        **ğŸ“Š Balance Report:**
        Click ğŸ“Š Balance Report
        """
        await update.message.reply_text(help_text)

def main():
    application = Application.builder().token(BOT_TOKEN).build()
    bot = SalaryBot()
    
    # Ø¥Ø¶Ø§ÙØ© handlers
    application.add_handler(CommandHandler("start", bot.start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, bot.handle_message))
    
    print("ğŸš€ Bot is running with buttons...")
    application.run_polling()

if __name__ == "__main__":
    main()
